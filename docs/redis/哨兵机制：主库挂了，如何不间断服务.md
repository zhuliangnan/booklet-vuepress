## 哨兵机制：主库挂了，如何不间断服务

> 哨兵机制的主要职责: 
>
> 1、`监控`：通过PING来监控主从 
>
> 2、`选主`：主库挂了，从从库中按一定的机制选择一个新主库 
>
> 3、`通知`：通知其他从库和客户端新的主库信息

### 哨兵机制的基本流程

![img](/redis/base/efcfa517d0f09d057be7da32a84cf2a1.jpg)

### 哨兵如何判断下线?(主观下线和客观下线)

> `主观下线`
>
> `哨兵进程`会使用 `PING 命令`检测它自己和主、从库的网络连接情况，用来判断实例的状态。如果哨兵发现主库或从库对 PING 命令的响应超时了，那么，哨兵就会先把它标记为“主观下线”。
>
> 如果`检测的是从库`，那么，哨兵简单地把它标记为“`主观下线`”就行了，因为从库的下线影响一般不太大，集群的对外服务不会间断。

> `客观下线`
>
> 但是，如果检测的是主库，`可能误判`，一般会发生在`集群网络压力较大`、`网络拥塞`，或者是`主库本身压力较大`的情况下
>
> 它通常会采用`多实例组成的集群模式`进行部署，这也被称为`哨兵集群`。`引入多个哨兵实例一起来判断`，就可以避免单个哨兵因为自身网络状况不好，而误判主库下线的情况。同时，多个哨兵的网络同时不稳定的概率较小，由它们一起做决策，误判率也能降低。
>
> 客观下线”的标准就是，当有 N 个哨兵实例时，最好要有` N/2 + 1` 个实例判断主库为“主观下线”，`才能最终判定主库为“客观下线`”。

客观下线判断示意图	

![img](/redis/base/1945703abf16ee14e2f7559873e4e60d-16328109273262.jpg)

### 哨兵如何选定新主库？（筛选->打分）

> A.筛选过程：
>
> ​     1、从库是否在线
>
> ​     2、网络连接状态 -- 你使用配置项 `down-after-milliseconds * 10`。其中，`down-after-milliseconds` 是我们认定`主从库断连的最大连接超时时间`。如果在 `down-after-milliseconds` 毫秒 内，主从节点都没有通过网络联系上，我们就可以认为主从节点断连了,如果发生断连的次数超过了 `10` 次，就说明这个从库的网络状况不好，`不适合作为新主库`。
>
> B、三轮打分过程。
>
> `只要在某一轮中，有从库得分最高，那么它就是主库了`，选主过程到此结束。如果没有出现得分最高的从库，那么就继续进行下一轮。

> `第一轮：优先级最高的从库得分高(优先级)。`

用户可以通过 `slave-priority` 配置项，给不同的从库设置不同优先级。

比如，你有两个从库，它们的内存大小不一样，你可以手动给内存大的实例设置一个高优先级。在选主时，哨兵会给优先级高的从库打高分，如果有一个从库优先级最高，那么它就是新主库了。如果从库的优先级都一样，那么哨兵开始第二轮打分。

> `第二轮：和旧主库同步程度最接近的从库得分高(复制进度)。`

`repl_backlog_buffer `这个缓冲区重，它的 `slave_repl_offset` 需要最接近 `master_repl_offset`。

如果在所有从库中，有从库的 slave_repl_offset 最接近 master_repl_offset，那么它的得分就最高，可以作为新主库。

就像下图所示，旧主库的 master_repl_offset 是 1000，从库 1、2 和 3 的 slave_repl_offset 分别是 950、990 和 900，那么，从库 2 就应该被选为新主库。

![img](/redis/base/626yy88853a2d15b5196b922367140df.jpg)

> `第三轮：ID 号小的从库得分高(ID号)。`

每个实例都会有一个 ID，这个 ID 就类似于这里的从库的编号。

目前，Redis 在选主库时，有一个默认的规定：在优先级和复制进度都相同的情况下，`ID 号最小的从库得分最高，会被选为新主库`。

### 提问：哨兵在操作主从切换的过程中，客户端能否正常地进行请求操作？

如果客户端使用了`读写分离`，那么`读请求可以在从库上正常执行`，不会受到影响。但是`由于此时主库已经挂了`，而且哨兵还没有选出新的主库，所以在这期间写`请求会失败`

失败持续的时间 = 哨兵切换主从的时间 + 客户端感知到新主库 的时间。

`如果不想让业务感知到异常`，客户端只能把`写失败的请求先缓存起来或写入消息队列中间件中`，等哨兵切换完主从后，再把这些写请求发给新的主库，但这种场景`只适合`对`写入请求返回值不敏感`的业务，而且还需要业务层做适配，`另外主从切换时间过长，也会导致客户端或消息队列中间件缓存写请求过多，切换完成之后重放这些请求的时间变长`。