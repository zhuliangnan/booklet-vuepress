<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>线程池：业务代码最常用也最容易犯错的组件 | 记在小本本上</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/logo.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <script data-ad-client="ca-pub-2245427233262012" async="true" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <meta name="description" content="Java 基础，面经手册，Go语言教程，MySql从入门到实战，Redis从入门到入土，设计模式，杂文，摄影...">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/0.styles.a98061bf.css" as="style"><link rel="preload" href="/assets/js/app.75796fb8.js" as="script"><link rel="preload" href="/assets/js/5.4faacd21.js" as="script"><link rel="preload" href="/assets/js/70.8c66f40e.js" as="script"><link rel="preload" href="/assets/js/9.fd263465.js" as="script"><link rel="prefetch" href="/assets/js/10.c4edd8fe.js"><link rel="prefetch" href="/assets/js/100.8577f6af.js"><link rel="prefetch" href="/assets/js/101.db3b0d0a.js"><link rel="prefetch" href="/assets/js/102.3d9df0d1.js"><link rel="prefetch" href="/assets/js/103.7317b5f1.js"><link rel="prefetch" href="/assets/js/104.34b5a3a7.js"><link rel="prefetch" href="/assets/js/105.beb4f8b2.js"><link rel="prefetch" href="/assets/js/106.d9017938.js"><link rel="prefetch" href="/assets/js/107.a957bd64.js"><link rel="prefetch" href="/assets/js/108.d82ba6c3.js"><link rel="prefetch" href="/assets/js/109.981e409d.js"><link rel="prefetch" href="/assets/js/11.3ff6d2f6.js"><link rel="prefetch" href="/assets/js/110.9ef40cbb.js"><link rel="prefetch" href="/assets/js/111.60a2ebc0.js"><link rel="prefetch" href="/assets/js/112.0bc42df1.js"><link rel="prefetch" href="/assets/js/113.25b23bfe.js"><link rel="prefetch" href="/assets/js/114.862ffc23.js"><link rel="prefetch" href="/assets/js/115.82daf396.js"><link rel="prefetch" href="/assets/js/116.b3fb800e.js"><link rel="prefetch" href="/assets/js/117.03c974cf.js"><link rel="prefetch" href="/assets/js/118.cf235b2a.js"><link rel="prefetch" href="/assets/js/119.1b35753c.js"><link rel="prefetch" href="/assets/js/12.79cabd30.js"><link rel="prefetch" href="/assets/js/120.01960f7b.js"><link rel="prefetch" href="/assets/js/121.2a9ae616.js"><link rel="prefetch" href="/assets/js/122.436ff9c4.js"><link rel="prefetch" href="/assets/js/123.717748ed.js"><link rel="prefetch" href="/assets/js/124.097f6032.js"><link rel="prefetch" href="/assets/js/125.19a7b81f.js"><link rel="prefetch" href="/assets/js/126.6edd6221.js"><link rel="prefetch" href="/assets/js/127.ecd75508.js"><link rel="prefetch" href="/assets/js/128.6e80ca7d.js"><link rel="prefetch" href="/assets/js/129.f14283ce.js"><link rel="prefetch" href="/assets/js/13.ce54800d.js"><link rel="prefetch" href="/assets/js/130.caced305.js"><link rel="prefetch" href="/assets/js/131.54da0def.js"><link rel="prefetch" href="/assets/js/132.bf238ddf.js"><link rel="prefetch" href="/assets/js/133.86ff1792.js"><link rel="prefetch" href="/assets/js/134.c92a4c9f.js"><link rel="prefetch" href="/assets/js/135.aeb77269.js"><link rel="prefetch" href="/assets/js/136.1c4ae91d.js"><link rel="prefetch" href="/assets/js/137.ea75a8e0.js"><link rel="prefetch" href="/assets/js/138.e81868a8.js"><link rel="prefetch" href="/assets/js/139.42d45662.js"><link rel="prefetch" href="/assets/js/14.8e633470.js"><link rel="prefetch" href="/assets/js/140.f6e17570.js"><link rel="prefetch" href="/assets/js/141.9b33189a.js"><link rel="prefetch" href="/assets/js/142.03ba2c00.js"><link rel="prefetch" href="/assets/js/15.e56523ce.js"><link rel="prefetch" href="/assets/js/16.6732e23b.js"><link rel="prefetch" href="/assets/js/17.195f916a.js"><link rel="prefetch" href="/assets/js/18.fbb265f7.js"><link rel="prefetch" href="/assets/js/19.04cf1a70.js"><link rel="prefetch" href="/assets/js/20.4ab9e6fe.js"><link rel="prefetch" href="/assets/js/21.64913197.js"><link rel="prefetch" href="/assets/js/22.a5a85516.js"><link rel="prefetch" href="/assets/js/23.ea9d25f6.js"><link rel="prefetch" href="/assets/js/24.91ef6425.js"><link rel="prefetch" href="/assets/js/25.9dbb3439.js"><link rel="prefetch" href="/assets/js/26.6c7d6d9c.js"><link rel="prefetch" href="/assets/js/27.7e49719b.js"><link rel="prefetch" href="/assets/js/28.2e0b2130.js"><link rel="prefetch" href="/assets/js/29.81ae5b3a.js"><link rel="prefetch" href="/assets/js/30.b86160da.js"><link rel="prefetch" href="/assets/js/31.783773e8.js"><link rel="prefetch" href="/assets/js/32.d3283304.js"><link rel="prefetch" href="/assets/js/33.6618c191.js"><link rel="prefetch" href="/assets/js/34.9d600980.js"><link rel="prefetch" href="/assets/js/35.e40dfefd.js"><link rel="prefetch" href="/assets/js/36.d72e25cd.js"><link rel="prefetch" href="/assets/js/37.2e4fe0c5.js"><link rel="prefetch" href="/assets/js/38.2a4c0d91.js"><link rel="prefetch" href="/assets/js/39.a08c6583.js"><link rel="prefetch" href="/assets/js/40.a0f95162.js"><link rel="prefetch" href="/assets/js/41.17424686.js"><link rel="prefetch" href="/assets/js/42.1894c5ab.js"><link rel="prefetch" href="/assets/js/43.26882514.js"><link rel="prefetch" href="/assets/js/44.f73d4e93.js"><link rel="prefetch" href="/assets/js/45.00ef05ff.js"><link rel="prefetch" href="/assets/js/46.afb22169.js"><link rel="prefetch" href="/assets/js/47.8a4efd9e.js"><link rel="prefetch" href="/assets/js/48.477392b5.js"><link rel="prefetch" href="/assets/js/49.113e46d3.js"><link rel="prefetch" href="/assets/js/50.88ee9d2c.js"><link rel="prefetch" href="/assets/js/51.4d480c77.js"><link rel="prefetch" href="/assets/js/52.446f3877.js"><link rel="prefetch" href="/assets/js/53.965d7cc0.js"><link rel="prefetch" href="/assets/js/54.8a765cac.js"><link rel="prefetch" href="/assets/js/55.658cb209.js"><link rel="prefetch" href="/assets/js/56.c73fd3a1.js"><link rel="prefetch" href="/assets/js/57.0de02c93.js"><link rel="prefetch" href="/assets/js/58.1ca14dfb.js"><link rel="prefetch" href="/assets/js/59.d9e670a1.js"><link rel="prefetch" href="/assets/js/6.841da28e.js"><link rel="prefetch" href="/assets/js/60.203398fb.js"><link rel="prefetch" href="/assets/js/61.3a15f48d.js"><link rel="prefetch" href="/assets/js/62.f7eacfdd.js"><link rel="prefetch" href="/assets/js/63.34a07196.js"><link rel="prefetch" href="/assets/js/64.803bfd15.js"><link rel="prefetch" href="/assets/js/65.31540090.js"><link rel="prefetch" href="/assets/js/66.7b143ddc.js"><link rel="prefetch" href="/assets/js/67.9b649dcb.js"><link rel="prefetch" href="/assets/js/68.ca4a8d86.js"><link rel="prefetch" href="/assets/js/69.40fa5e04.js"><link rel="prefetch" href="/assets/js/7.cf3563c1.js"><link rel="prefetch" href="/assets/js/71.2784ba44.js"><link rel="prefetch" href="/assets/js/72.a2c25326.js"><link rel="prefetch" href="/assets/js/73.9f98acac.js"><link rel="prefetch" href="/assets/js/74.7b0cc7bb.js"><link rel="prefetch" href="/assets/js/75.6055ffaa.js"><link rel="prefetch" href="/assets/js/76.e632d141.js"><link rel="prefetch" href="/assets/js/77.84bdb53f.js"><link rel="prefetch" href="/assets/js/78.328e1567.js"><link rel="prefetch" href="/assets/js/79.3281a1e2.js"><link rel="prefetch" href="/assets/js/8.5b0ea1a7.js"><link rel="prefetch" href="/assets/js/80.c07bd478.js"><link rel="prefetch" href="/assets/js/81.ee6ac122.js"><link rel="prefetch" href="/assets/js/82.5f973b0e.js"><link rel="prefetch" href="/assets/js/83.37d90395.js"><link rel="prefetch" href="/assets/js/84.9273b725.js"><link rel="prefetch" href="/assets/js/85.d58beb52.js"><link rel="prefetch" href="/assets/js/86.b268b510.js"><link rel="prefetch" href="/assets/js/87.00fa30e4.js"><link rel="prefetch" href="/assets/js/88.19884558.js"><link rel="prefetch" href="/assets/js/89.02d12f70.js"><link rel="prefetch" href="/assets/js/90.251bae27.js"><link rel="prefetch" href="/assets/js/91.4f8d0d0d.js"><link rel="prefetch" href="/assets/js/92.001a82da.js"><link rel="prefetch" href="/assets/js/93.39bca74f.js"><link rel="prefetch" href="/assets/js/94.2b8503d6.js"><link rel="prefetch" href="/assets/js/95.a0f745cb.js"><link rel="prefetch" href="/assets/js/96.f3e6f044.js"><link rel="prefetch" href="/assets/js/97.f058f603.js"><link rel="prefetch" href="/assets/js/98.c5bd0deb.js"><link rel="prefetch" href="/assets/js/99.516de4bd.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.3fe60842.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.2f652080.js"><link rel="prefetch" href="/assets/js/vendors~notification.b7c38425.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a98061bf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">记在小本本上</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/java-guide/" class="nav-link router-link-active">
  Java开发避坑指南📝
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程语言☕" class="dropdown-title"><span class="title">编程语言☕</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程语言☕" class="mobile-dropdown-title"><span class="title">编程语言☕</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Golang
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/golang/" class="nav-link">
  Golang入门基础教程🧑‍🚀
</a></li></ul></li><li class="dropdown-item"><h4>
          Golang(杂谈)
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/golang-note/GoLand 控制台输出中文乱码的解决方案.html" class="nav-link">
  GoLand 控制台输出中文乱码的解决方案👿
</a></li><li class="dropdown-subitem"><a href="/golang-note/Go语言生成二维码.html" class="nav-link">
  Go语言生成二维码🤖
</a></li><li class="dropdown-subitem"><a href="/golang-note/Golang 新手可能会踩的 50+ 个坑.html" class="nav-link">
  Golang 新手可能会踩的 50+ 个坑👽
</a></li><li class="dropdown-subitem"><a href="/golang-note/GoLand 解决无法导入自定义包的问题.html" class="nav-link">
  GoLand 解决无法导入自定义包的问题🤬
</a></li></ul></li><li class="dropdown-item"><h4>
          Java(杂谈)
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java-note/Springboot引用外部jar包并打包成jar程序运行.html" class="nav-link">
  Springboot引用外部jar包并打包成jar程序运行😺
</a></li><li class="dropdown-subitem"><a href="/java-note/Error-java无效的源发行版11错误.html" class="nav-link">
  Error:java: 无效的源发行版: 11错误🙀
</a></li><li class="dropdown-subitem"><a href="/java-note/基于Spring Aop实现用户操作日志监控.html" class="nav-link">
  基于Spring Aop实现用户操作日志监控🙉
</a></li><li class="dropdown-subitem"><a href="/java-note/fastjson基本使用.html" class="nav-link">
  fastjson基本使用🤠
</a></li><li class="dropdown-subitem"><a href="/java-note/spring项目中手动获取bean.html" class="nav-link">
  spring项目中手动获取bean🤠
</a></li></ul></li><li class="dropdown-item"><h4>
          Gradle(杂谈)
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/gradle-note/Idea实现gradle打jar包.html" class="nav-link">
  Idea实现gradle打jar包😺
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件🀄" class="dropdown-title"><span class="title">中间件🀄</span> <span class="arrow down"></span></button> <button type="button" aria-label="中间件🀄" class="mobile-dropdown-title"><span class="title">中间件🀄</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Redis
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/redis/" class="nav-link">
  Redis基础到实战(详细)🎮
</a></li><li class="dropdown-subitem"><a href="/redis/other/Redis操作速查手册.html" class="nav-link">
  Redis操作速查手册🍒
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法⏳" class="dropdown-title"><span class="title">算法⏳</span> <span class="arrow down"></span></button> <button type="button" aria-label="算法⏳" class="mobile-dropdown-title"><span class="title">算法⏳</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          算法
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/leetcode/" class="nav-link">
  LeetCode
</a></li><li class="dropdown-subitem"><a href="/tooffer/" class="nav-link">
  剑指offer
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库💊" class="dropdown-title"><span class="title">数据库💊</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库💊" class="mobile-dropdown-title"><span class="title">数据库💊</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Mysql
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mysql/" class="nav-link">
  Mysql基础到实战(详细)🕹️
</a></li></ul></li><li class="dropdown-item"><h4>
          Mysql(杂谈)
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mysql-note/MySQL索引及实际应用.html" class="nav-link">
  MySQL索引及实际应用🎉
</a></li></ul></li><li class="dropdown-item"><h4>
          Oracle(杂谈)
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/oracle-note/ORA-01756报错的解决方案中文编码错误.html" class="nav-link">
  ORA-01756报错的解决方案中文编码错误🥝
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="容器🐳" class="dropdown-title"><span class="title">容器🐳</span> <span class="arrow down"></span></button> <button type="button" aria-label="容器🐳" class="mobile-dropdown-title"><span class="title">容器🐳</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          docker🐳
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/docker/" class="nav-link">
  docker操作手册🎉
</a></li></ul></li><li class="dropdown-item"><h4>
          docker(杂谈)🐬
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/docker-note/Docker时间与linux不一致.html" class="nav-link">
  Docker时间与linux不一致🐠
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="小册|部署|PDF📜" class="dropdown-title"><span class="title">小册|部署|PDF📜</span> <span class="arrow down"></span></button> <button type="button" aria-label="小册|部署|PDF📜" class="mobile-dropdown-title"><span class="title">小册|部署|PDF📜</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Linux
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/linux/Linux常用操作速查.html" class="nav-link">
  Linux常用操作速查❤🐦
</a></li></ul></li><li class="dropdown-item"><h4>
          Linux小册(环境安装)
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/linux/deploy/java环境安装.html" class="nav-link">
  java环境安装🌱
</a></li><li class="dropdown-subitem"><a href="/linux/deploy/redis环境安装.html" class="nav-link">
  redis环境安装(docker)🐳
</a></li><li class="dropdown-subitem"><a href="/linux/deploy/zookeeper环境安装.html" class="nav-link">
  zookeeper环境安装(linux)🦕
</a></li><li class="dropdown-subitem"><a href="/linux/deploy/KafKa安装教程.html" class="nav-link">
  KafKa安装教程(Linux)🍉
</a></li></ul></li><li class="dropdown-item"><h4>
          PDF
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mianshi/" class="nav-link">
  面试知识点💤💭
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他💬" class="dropdown-title"><span class="title">其他💬</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他💬" class="mobile-dropdown-title"><span class="title">其他💬</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          git
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/git/git-clone-10054或者443问题.html" class="nav-link">
  git-clone-10054或者443问题🥥
</a></li></ul></li><li class="dropdown-item"><h4>
          工作流
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/flowable/Flowable工作流快速入门.html" class="nav-link">
  Flowable工作流快速入门🎉
</a></li></ul></li><li class="dropdown-item"><h4>
          npm
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/front/webpack-dev-server不是内部或外部命令，也不是可运行的程序.html" class="nav-link">
  webpack-dev-server不是内部或外部命令，也不是可运行的程序🥥
</a></li></ul></li><li class="dropdown-item"><h4>
          ES
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/front/elasticsearch空index搜索排序报错问题Nomapping found for occurTime in order to sort on.html" class="nav-link">
  elasticsearch空index搜索排序报错问题:No mapping found for occurTime in order to sort on🥥
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="摄影📷🎥" class="dropdown-title"><span class="title">摄影📷🎥</span> <span class="arrow down"></span></button> <button type="button" aria-label="摄影📷🎥" class="mobile-dropdown-title"><span class="title">摄影📷🎥</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          照片
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/camera/" class="nav-link">
  近期拍摄的相片(后期)🏳️‍
</a></li></ul></li><li class="dropdown-item"><h4>
          摄影
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/movie_camera/" class="nav-link">
  近期拍摄的视频🏴‍
</a></li></ul></li><li class="dropdown-item"><h4>
          杂谈
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/camera_color/后期调色.html" class="nav-link">
  后期调色🐳‍
</a></li></ul></li></ul></div></div> <a href="https://github.com/vuejs/vuepress" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/java-guide/" class="nav-link router-link-active">
  Java开发避坑指南📝
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程语言☕" class="dropdown-title"><span class="title">编程语言☕</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程语言☕" class="mobile-dropdown-title"><span class="title">编程语言☕</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Golang
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/golang/" class="nav-link">
  Golang入门基础教程🧑‍🚀
</a></li></ul></li><li class="dropdown-item"><h4>
          Golang(杂谈)
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/golang-note/GoLand 控制台输出中文乱码的解决方案.html" class="nav-link">
  GoLand 控制台输出中文乱码的解决方案👿
</a></li><li class="dropdown-subitem"><a href="/golang-note/Go语言生成二维码.html" class="nav-link">
  Go语言生成二维码🤖
</a></li><li class="dropdown-subitem"><a href="/golang-note/Golang 新手可能会踩的 50+ 个坑.html" class="nav-link">
  Golang 新手可能会踩的 50+ 个坑👽
</a></li><li class="dropdown-subitem"><a href="/golang-note/GoLand 解决无法导入自定义包的问题.html" class="nav-link">
  GoLand 解决无法导入自定义包的问题🤬
</a></li></ul></li><li class="dropdown-item"><h4>
          Java(杂谈)
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java-note/Springboot引用外部jar包并打包成jar程序运行.html" class="nav-link">
  Springboot引用外部jar包并打包成jar程序运行😺
</a></li><li class="dropdown-subitem"><a href="/java-note/Error-java无效的源发行版11错误.html" class="nav-link">
  Error:java: 无效的源发行版: 11错误🙀
</a></li><li class="dropdown-subitem"><a href="/java-note/基于Spring Aop实现用户操作日志监控.html" class="nav-link">
  基于Spring Aop实现用户操作日志监控🙉
</a></li><li class="dropdown-subitem"><a href="/java-note/fastjson基本使用.html" class="nav-link">
  fastjson基本使用🤠
</a></li><li class="dropdown-subitem"><a href="/java-note/spring项目中手动获取bean.html" class="nav-link">
  spring项目中手动获取bean🤠
</a></li></ul></li><li class="dropdown-item"><h4>
          Gradle(杂谈)
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/gradle-note/Idea实现gradle打jar包.html" class="nav-link">
  Idea实现gradle打jar包😺
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件🀄" class="dropdown-title"><span class="title">中间件🀄</span> <span class="arrow down"></span></button> <button type="button" aria-label="中间件🀄" class="mobile-dropdown-title"><span class="title">中间件🀄</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Redis
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/redis/" class="nav-link">
  Redis基础到实战(详细)🎮
</a></li><li class="dropdown-subitem"><a href="/redis/other/Redis操作速查手册.html" class="nav-link">
  Redis操作速查手册🍒
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法⏳" class="dropdown-title"><span class="title">算法⏳</span> <span class="arrow down"></span></button> <button type="button" aria-label="算法⏳" class="mobile-dropdown-title"><span class="title">算法⏳</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          算法
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/leetcode/" class="nav-link">
  LeetCode
</a></li><li class="dropdown-subitem"><a href="/tooffer/" class="nav-link">
  剑指offer
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库💊" class="dropdown-title"><span class="title">数据库💊</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库💊" class="mobile-dropdown-title"><span class="title">数据库💊</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Mysql
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mysql/" class="nav-link">
  Mysql基础到实战(详细)🕹️
</a></li></ul></li><li class="dropdown-item"><h4>
          Mysql(杂谈)
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mysql-note/MySQL索引及实际应用.html" class="nav-link">
  MySQL索引及实际应用🎉
</a></li></ul></li><li class="dropdown-item"><h4>
          Oracle(杂谈)
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/oracle-note/ORA-01756报错的解决方案中文编码错误.html" class="nav-link">
  ORA-01756报错的解决方案中文编码错误🥝
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="容器🐳" class="dropdown-title"><span class="title">容器🐳</span> <span class="arrow down"></span></button> <button type="button" aria-label="容器🐳" class="mobile-dropdown-title"><span class="title">容器🐳</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          docker🐳
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/docker/" class="nav-link">
  docker操作手册🎉
</a></li></ul></li><li class="dropdown-item"><h4>
          docker(杂谈)🐬
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/docker-note/Docker时间与linux不一致.html" class="nav-link">
  Docker时间与linux不一致🐠
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="小册|部署|PDF📜" class="dropdown-title"><span class="title">小册|部署|PDF📜</span> <span class="arrow down"></span></button> <button type="button" aria-label="小册|部署|PDF📜" class="mobile-dropdown-title"><span class="title">小册|部署|PDF📜</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Linux
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/linux/Linux常用操作速查.html" class="nav-link">
  Linux常用操作速查❤🐦
</a></li></ul></li><li class="dropdown-item"><h4>
          Linux小册(环境安装)
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/linux/deploy/java环境安装.html" class="nav-link">
  java环境安装🌱
</a></li><li class="dropdown-subitem"><a href="/linux/deploy/redis环境安装.html" class="nav-link">
  redis环境安装(docker)🐳
</a></li><li class="dropdown-subitem"><a href="/linux/deploy/zookeeper环境安装.html" class="nav-link">
  zookeeper环境安装(linux)🦕
</a></li><li class="dropdown-subitem"><a href="/linux/deploy/KafKa安装教程.html" class="nav-link">
  KafKa安装教程(Linux)🍉
</a></li></ul></li><li class="dropdown-item"><h4>
          PDF
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mianshi/" class="nav-link">
  面试知识点💤💭
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他💬" class="dropdown-title"><span class="title">其他💬</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他💬" class="mobile-dropdown-title"><span class="title">其他💬</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          git
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/git/git-clone-10054或者443问题.html" class="nav-link">
  git-clone-10054或者443问题🥥
</a></li></ul></li><li class="dropdown-item"><h4>
          工作流
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/flowable/Flowable工作流快速入门.html" class="nav-link">
  Flowable工作流快速入门🎉
</a></li></ul></li><li class="dropdown-item"><h4>
          npm
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/front/webpack-dev-server不是内部或外部命令，也不是可运行的程序.html" class="nav-link">
  webpack-dev-server不是内部或外部命令，也不是可运行的程序🥥
</a></li></ul></li><li class="dropdown-item"><h4>
          ES
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/front/elasticsearch空index搜索排序报错问题Nomapping found for occurTime in order to sort on.html" class="nav-link">
  elasticsearch空index搜索排序报错问题:No mapping found for occurTime in order to sort on🥥
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="摄影📷🎥" class="dropdown-title"><span class="title">摄影📷🎥</span> <span class="arrow down"></span></button> <button type="button" aria-label="摄影📷🎥" class="mobile-dropdown-title"><span class="title">摄影📷🎥</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          照片
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/camera/" class="nav-link">
  近期拍摄的相片(后期)🏳️‍
</a></li></ul></li><li class="dropdown-item"><h4>
          摄影
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/movie_camera/" class="nav-link">
  近期拍摄的视频🏴‍
</a></li></ul></li><li class="dropdown-item"><h4>
          杂谈
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/camera_color/后期调色.html" class="nav-link">
  后期调色🐳‍
</a></li></ul></li></ul></div></div> <a href="https://github.com/vuejs/vuepress" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>代码</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/java-guide/" aria-current="page" class="sidebar-link">导语</a></li><li><a href="/java-guide/并发工具类库，线程安全就高枕无忧了吗？.html" class="sidebar-link">并发工具类库，线程安全就高枕无忧了吗？</a></li><li><a href="/java-guide/代码加锁：不要让“锁”事成为烦心事.html" class="sidebar-link">代码加锁：不要让“锁”事成为烦心事</a></li><li><a href="/java-guide/线程池：业务代码最常用也最容易犯错的组件.html" class="active sidebar-link">线程池：业务代码最常用也最容易犯错的组件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java-guide/线程池：业务代码最常用也最容易犯错的组件.html#线程池-业务代码最常用也最容易犯错的组件" class="sidebar-link">线程池：业务代码最常用也最容易犯错的组件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java-guide/线程池：业务代码最常用也最容易犯错的组件.html#线程池的声明需要手动进行" class="sidebar-link">线程池的声明需要手动进行</a></li><li class="sidebar-sub-header"><a href="/java-guide/线程池：业务代码最常用也最容易犯错的组件.html#线程池线程管理策略详解" class="sidebar-link">线程池线程管理策略详解</a></li><li class="sidebar-sub-header"><a href="/java-guide/线程池：业务代码最常用也最容易犯错的组件.html#务必确认清楚线程池本身是不是复用的" class="sidebar-link">务必确认清楚线程池本身是不是复用的</a></li><li class="sidebar-sub-header"><a href="/java-guide/线程池：业务代码最常用也最容易犯错的组件.html#需要仔细斟酌线程池的混用策略" class="sidebar-link">需要仔细斟酌线程池的混用策略</a></li></ul></li></ul></li><li><a href="/java-guide/连接池：别让连接池帮了倒忙.html" class="sidebar-link">连接池：别让连接池帮了倒忙</a></li><li><a href="/java-guide/HTTP调用：你考虑到超时、重试、并发了吗？.html" class="sidebar-link">HTTP调用：你考虑到超时、重试、并发了吗？</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>设计</span> <!----></p> <!----></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>安全</span> <!----></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="线程池-业务代码最常用也最容易犯错的组件"><a href="#线程池-业务代码最常用也最容易犯错的组件" class="header-anchor">#</a> 线程池：业务代码最常用也最容易犯错的组件</h2> <p>线程的创建和销毁代价比较大，所以我们一般使用线程池来进行控制</p> <h3 id="线程池的声明需要手动进行"><a href="#线程池的声明需要手动进行" class="header-anchor">#</a> 线程池的声明需要手动进行</h3> <p>通过Java 中的 Executors 类我们可以很方便的快速创建线程池，但是<code>《阿里巴巴 Java 开发手册》</code>中提到，禁止使用这些方法来创建线程池，而应该<code>手动 new ThreadPoolExecutor 来创建线程池</code></p> <ul><li>方便我们更加直观的评估线程池的各个参数</li> <li>任何时候，都应该为自定义线程池指定有意义的名称，以方便排查问题</li></ul> <p>这一条规则的背后，是大量血淋淋的生产事故，最典型的就是 <code>newFixedThreadPool</code> 和 <code>newCachedThreadPool</code>，可能因为资源耗尽导致 <code>OOM</code> 问题。</p> <p>我们写一段测试代码，来初始化一个单线程的 <code>FixedThreadPool</code>，循环 1 亿次向线程池提交任务，每个任务都会<code>创建</code>一个比较大的字符串<code>然后</code>休眠一小时`：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FixedThreadPoolController</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * Executors.newSingleThreadScheduledExecutor()实现定时任务
     * 1表示时间单位的数值 TimeUnit.SECONDS  延时单位为秒
     * */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">printStats</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolExecutor</span> threadPool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadScheduledExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;=========================&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Pool Size: {}&quot;</span><span class="token punctuation">,</span> threadPool<span class="token punctuation">.</span><span class="token function">getPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Active Threads: {}&quot;</span><span class="token punctuation">,</span> threadPool<span class="token punctuation">.</span><span class="token function">getActiveCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Number of Tasks Completed: {}&quot;</span><span class="token punctuation">,</span> threadPool<span class="token punctuation">.</span><span class="token function">getCompletedTaskCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Number of Tasks in Queue: {}&quot;</span><span class="token punctuation">,</span> threadPool<span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;=========================&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;oom1&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">oom1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>

        <span class="token class-name">ThreadPoolExecutor</span> threadPool <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">)</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//打印线程池的信息，稍后我会解释这段代码</span>
        <span class="token function">printStats</span><span class="token punctuation">(</span>threadPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100000000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> payload <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000000</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>__ <span class="token operator">-&gt;</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>HOURS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        threadPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        threadPool<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>HOURS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/java-guide/image-20211207151000440.png" alt="image-20211207151000440"></p> <p><img src="/java-guide/image-20211207151515635.png" alt="image-20211207151515635"></p> <p>执行程序后不久,随着队列任务的急剧上升,<code>jvisualvm.exe</code>中也能看到使用内存在缓步上升，日志中就出现了如下 OOM(ps:如果你的机器内存比较大，可能要等一会)：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>Exception <span class="token keyword">in</span> thread <span class="token string">&quot;http-nio-45678-ClientPoller&quot;</span> java.lang.OutOfMemoryError: GC overhead limit exceeded
</code></pre></div><blockquote><p>翻看 <code>newFixedThreadPool</code> 方法的源码不难发现，线程池的工作队列直接 new 了一个 <code>LinkedBlockingQueue</code>，而默认构造方法的 <code>LinkedBlockingQueue 是一个 Integer.MAX_VALUE 长度的队列</code>，可以认为是<code>无界</code>的,源码如下：</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token keyword">int</span> nThreads<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>nThreads<span class="token punctuation">,</span> nThreads<span class="token punctuation">,</span>
                                      <span class="token number">0L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span>
                                      <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token keyword">public</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre></div><p>我们再把刚才的例子稍微改一下，改为使用 <code>newCachedThreadPool</code> 方法来获得线程池。程序运行不久后（你的cpu会飙满），同样看到了如下 OOM 异常：</p> <p><img src="/java-guide/image-20211208112143167.png" alt="image-20211208112143167"></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span><span class="token number">11</span>:30:30.487<span class="token punctuation">]</span> <span class="token punctuation">[</span>http-nio-45678-exec-1<span class="token punctuation">]</span> <span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> <span class="token punctuation">[</span>.a.c.c.C.<span class="token punctuation">[</span>.<span class="token punctuation">[</span>.<span class="token punctuation">[</span>/<span class="token punctuation">]</span>.<span class="token punctuation">[</span>dispatcherServlet<span class="token punctuation">]</span>:175 <span class="token punctuation">]</span> - Servlet.service<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> servlet <span class="token punctuation">[</span>dispatcherServlet<span class="token punctuation">]</span> <span class="token keyword">in</span> context with path <span class="token punctuation">[</span><span class="token punctuation">]</span> threw exception <span class="token punctuation">[</span>Handler dispatch failed<span class="token punctuation">;</span> nested exception is java.lang.OutOfMemoryError: unable to create new native thread<span class="token punctuation">]</span> with root cause
java.lang.OutOfMemoryError: unable to create new native thread 
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>翻看 <code>newCachedThreadPool</code> 的源码可以看到，这种线程池的最大线程数是 <code>Integer.MAX_VALUE</code>，可以认为是没有上限的，而其<code>工作队列 SynchronousQueue</code> 是一个<code>没有存储空间的阻塞队列</code>。这意味着，只要有请求到来，就必须找到一条工作线程来处理，如果当前<code>没有空闲的线程就再创建一条新的</code>。所以无限制创建下去必然OOM</p></div> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">,</span>
                                  <span class="token number">60L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span>
                                  <span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token operator">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="线程池线程管理策略详解"><a href="#线程池线程管理策略详解" class="header-anchor">#</a> 线程池线程管理策略详解</h3> <p>ps1.参数解释</p> <p><img src="/java-guide/image-20211208132219348.png" alt="image-20211208132219348"></p> <ul><li><strong>corePoolSize：</strong> 线程池核心线程数最大值</li> <li><strong>maximumPoolSize：</strong> 线程池最大线程数大小</li> <li><strong>keepAliveTime：</strong> 线程池中非核心线程空闲的存活时间大小</li> <li><strong>unit：</strong> 线程空闲存活时间单位</li> <li><strong>workQueue：</strong> 存放任务的阻塞队列</li> <li><strong>threadFactory：</strong> 用于设置创建线程的工厂，可以给创建的线程设置有意义的名字，可方便排查问题</li> <li><strong>handler：</strong> 线城池的饱和策略事件，主要有四种类型。</li></ul> <p>ps2:线程池拒接策略</p> <ol><li><strong>AbortPolicy</strong>：丢弃任务并抛出RejectedExecutionException异常</li> <li><strong>DiscardPolicy</strong>：丢弃任务，但是不抛出异常。</li> <li><strong>DisCardOldSetPolicy</strong>：丢弃队列最前面的任务，然后提交新来的任务</li> <li><strong>CallerRunPolicy</strong>：由调用线程（提交任务的线程，主线程）处理该任务</li></ol> <p>ps3: 使用Jodd记得引入包</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!-- https://mvnrepository.com/artifact/org.jodd/jodd-core --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.jodd<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jodd-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.0.13<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>首先，自定义一个线程池。这个线程池具有<code>2 个核心线程</code>、<code>5 个最大线程</code>、使用<code>容量为 10 的 ArrayBlockingQueue 阻塞队列</code>作为工作队列，使用默认的 <code>AbortPolicy 拒绝策略</code>，也就是任务添加到线程池失败会抛出 <code>RejectedExecutionException</code>。此外，我们借助了 <code>Jodd</code> 类库的 <code>ThreadFactoryBuilder</code> 方法来构造一个线程工厂，实现线程池线程的自定义命名。</p> <div class="language-java extra-class"><pre class="language-java"><code> <span class="token comment">/**
     * 初始化AtomicInteger
     * 循环20次每次+1的同时开启一个线程执行10s然后输出线程开始和结束的AtomicInteger的值
     * */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/03/01/right&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">AtomicInteger</span> atomicInteger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ThreadPoolExecutor</span> threadPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
                <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span>
                <span class="token number">5</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setNameFormat</span><span class="token punctuation">(</span><span class="token string">&quot;demo-threadpool-%d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>AbortPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//threadPool.allowCoreThreadTimeOut(true);</span>
        <span class="token function">printStats</span><span class="token punctuation">(</span>threadPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// AtomicInteger的CAS进行新增</span>
            <span class="token keyword">int</span> id <span class="token operator">=</span> atomicInteger<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                threadPool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{} started&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">}</span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{} finished&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;error submitting task {}&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                atomicInteger<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> atomicInteger<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">## 场景1 当核心线程满了之后不会立即扩容线程池，而是把任务堆积到工作队列中</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:42:49.654  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:42:50.655  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:42:50.656  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Pool Size: <span class="token number">2</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:42:50.656  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Active Threads: <span class="token number">2</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:42:50.657  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Number of Tasks Completed: <span class="token number">0</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:42:50.657  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Number of Tasks <span class="token keyword">in</span> Queue: <span class="token number">2</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:42:50.657  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:42:51.652  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:42:51.652  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Pool Size: <span class="token number">2</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:42:51.652  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Active Threads: <span class="token number">2</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:42:51.653  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Number of Tasks Completed: <span class="token number">0</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:42:51.653  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Number of Tasks <span class="token keyword">in</span> Queue: <span class="token number">2</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:42:51.653  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:42:52.653  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:42:52.655  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Pool Size: <span class="token number">2</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:42:52.658  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Active Threads: <span class="token number">2</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:42:52.658  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Number of Tasks Completed: <span class="token number">0</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:42:52.659  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Number of Tasks <span class="token keyword">in</span> Queue: <span class="token number">4</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:42:52.662  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:42:53.654  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>

<span class="token comment">## 场景2 当工作队列满了后扩容线程池，一直到线程个数达到 maximumPoolSize 为止，如果队列已满且达到了最大线程后还有任务进来，按照拒绝策略处理；</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:42:59.653  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:00.652  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:00.652  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Pool Size: <span class="token number">2</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:00.652  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Active Threads: <span class="token number">2</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:00.653  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Number of Tasks Completed: <span class="token number">2</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:00.653  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Number of Tasks <span class="token keyword">in</span> Queue: <span class="token number">9</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:00.653  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:01.653  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:01.653  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Pool Size: <span class="token number">2</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:01.653  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Active Threads: <span class="token number">2</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:01.653  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Number of Tasks Completed: <span class="token number">2</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:01.653  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Number of Tasks <span class="token keyword">in</span> Queue: <span class="token number">10</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:01.653  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:01.663  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>mo-threadpool-2<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token number">15</span> started
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:02.653  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:02.653  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Pool Size: <span class="token number">3</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:02.653  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Active Threads: <span class="token number">3</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:02.653  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Number of Tasks Completed: <span class="token number">2</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:02.654  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Number of Tasks <span class="token keyword">in</span> Queue: <span class="token number">10</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:02.654  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:02.664  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>mo-threadpool-3<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token number">16</span> started
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:03.654  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:03.655  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Pool Size: <span class="token number">4</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:03.655  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Active Threads: <span class="token number">4</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:03.656  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Number of Tasks Completed: <span class="token number">2</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:03.657  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Number of Tasks <span class="token keyword">in</span> Queue: <span class="token number">10</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:03.657  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:03.665  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>mo-threadpool-4<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token number">17</span> started
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:04.652  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:04.652  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Pool Size: <span class="token number">5</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:04.652  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Active Threads: <span class="token number">5</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:04.652  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Number of Tasks Completed: <span class="token number">2</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:04.652  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Number of Tasks <span class="token keyword">in</span> Queue: <span class="token number">10</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:04.652  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:04.680 ERROR <span class="token number">512224</span> --- <span class="token punctuation">[</span>nio-8080-exec-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> error submitting task <span class="token number">18</span>

java.util.concurrent.RejectedExecutionException: Task java.util.concurrent.FutureTask@441aaaee rejected from java.util.concurrent.ThreadPoolExecutor@7e78c9fa<span class="token punctuation">[</span>Running, pool size <span class="token operator">=</span> <span class="token number">5</span>, active threads <span class="token operator">=</span> <span class="token number">5</span>, queued tasks <span class="token operator">=</span> <span class="token number">10</span>, completed tasks <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">]</span>
	at java.util.concurrent.ThreadPoolExecutor<span class="token variable">$AbortPolicy</span>.rejectedExecution<span class="token punctuation">(</span>ThreadPoolExecutor.java:2063<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:1.8.0_251<span class="token punctuation">]</span>
	at java.util.concurrent.ThreadPoolExecutor.reject<span class="token punctuation">(</span>ThreadPoolExecutor.java:830<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:1.8.0_251<span class="token punctuation">]</span>
	at java.util.concurrent.ThreadPoolExecutor.execute<span class="token punctuation">(</span>ThreadPoolExecutor.java:1379<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:1.8.0_251<span class="token punctuation">]</span>
	at java.util.concurrent.AbstractExecutorService.submit<span class="token punctuation">(</span>AbstractExecutorService.java:112<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:1.8.0_251<span class="token punctuation">]</span>
	at com.zln.javaguide.demo1.controller.FixedThreadPoolController.lambda<span class="token variable">$right</span><span class="token variable">$6</span><span class="token punctuation">(</span>FixedThreadPoolController.java:110<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span>
	
<span class="token comment">## 场景3 当线程数大于核心线程数时，线程等待 keepAliveTime 后还是没有任务需要处理的话，收缩线程到核心线程数。</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:34.654  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:35.653  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:35.653  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Pool Size: <span class="token number">3</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:35.653  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Active Threads: <span class="token number">0</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:35.653  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Number of Tasks Completed: <span class="token number">17</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:35.653  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Number of Tasks <span class="token keyword">in</span> Queue: <span class="token number">0</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:35.653  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:36.654  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:36.654  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Pool Size: <span class="token number">3</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:36.654  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Active Threads: <span class="token number">0</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:36.654  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Number of Tasks Completed: <span class="token number">17</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:36.654  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Number of Tasks <span class="token keyword">in</span> Queue: <span class="token number">0</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:36.654  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:37.654  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:37.654  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Pool Size: <span class="token number">2</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:37.654  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Active Threads: <span class="token number">0</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:37.654  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Number of Tasks Completed: <span class="token number">17</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:37.654  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Number of Tasks <span class="token keyword">in</span> Queue: <span class="token number">0</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:37.654  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:38.654  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:38.654  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Pool Size: <span class="token number">2</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:38.654  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Active Threads: <span class="token number">0</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:38.654  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Number of Tasks Completed: <span class="token number">17</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:38.654  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Number of Tasks <span class="token keyword">in</span> Queue: <span class="token number">0</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:38.654  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:39.653  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:39.653  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Pool Size: <span class="token number">2</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:39.653  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Active Threads: <span class="token number">0</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:39.653  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Number of Tasks Completed: <span class="token number">17</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:39.653  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> Number of Tasks <span class="token keyword">in</span> Queue: <span class="token number">0</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:39.653  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2021</span>-12-08 <span class="token number">13</span>:43:40.654  INFO <span class="token number">512224</span> --- <span class="token punctuation">[</span>pool-2-thread-1<span class="token punctuation">]</span> c.z.j.d.c.FixedThreadPoolController      <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>

</code></pre></div><p>至此，我们可以总结出线程池默认的工作行为：</p> <ul><li>不会初始化 <code>corePoolSize</code> 个线程，有任务来了才创建工作线程；</li> <li>当<code>核心线程满</code>了之后<code>不会立即扩容线程池</code>，而是把任务<code>堆积</code>到<code>工作队列</code>中；</li> <li>当工作<code>队列满了</code>后<code>扩容线程池</code>，一直到线程个数达到<code>maximumPoolSize</code>为止；</li> <li>如果队列已满且达到了最大线程后还有任务进来，按照拒绝策略处理；</li> <li>当<code>线程数大于核心线程数</code>时，线程等待 <code>keepAliveTime</code> 后还是没有任务需要处理的话，<code>收缩</code>线程到<code>核心线程数</code>。</li></ul> <p>当然可以使用其他方法来打破这些约束</p> <ul><li>声明线程池后立即调用 <code>prestartAllCoreThreads</code> 方法，来<code>启动所有核心线程</code>；</li> <li>传入 <code>true</code> 给 <code>allowCoreThreadTimeOut</code> 方法，来让线程池在<code>空闲的时候</code>同样<code>回收核心线程</code>。</li></ul> <h3 id="务必确认清楚线程池本身是不是复用的"><a href="#务必确认清楚线程池本身是不是复用的" class="header-anchor">#</a> 务必确认清楚线程池本身是不是复用的</h3> <p>下面我们来模拟一个没有正确复用线程池导致线程数暴涨的栗子。</p> <div class="language-java extra-class"><pre class="language-java"><code> <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/03/02/wrong&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ThreadPoolExecutor</span> threadPool <span class="token operator">=</span> <span class="token class-name">ThreadPoolHelper</span><span class="token punctuation">.</span><span class="token function">getThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> payload <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000000</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>__ <span class="token operator">-&gt;</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;OK&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolHelper</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ThreadPoolExecutor</span> <span class="token function">getThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">)</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p><img src="/java-guide/image-20211208141309754.png" alt="image-20211208141309754"></p> <p><img src="/java-guide/image-20211208141415947.png" alt="image-20211208141415947"></p> <p>问题很容易发现getThreadPool 方法居然是每次都使用 Executors.newCachedThreadPool 来创建一个线程池。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>我们可以想到 newCachedThreadPool 会在需要时创建必要多的线程，业务代码的一次业务操作会向线程池提交多个慢任务，这样执行一次业务操作就会开启多个线程。如果业务操作并发量较大的话，的确有可能一下子开启几千个线程。</p> <p>但是你会发现线程数一段时间后会下降，翻看newCachedThreadPool 的定义就会发现，它的核心线程数是 0，而 keepAliveTime 是 60 秒，也就是在 60 秒之后所有的线程都是可以回收的。好吧，就因为这个特性，我们的业务程序死得没太难看。</p></div> <p>要修复这个 Bug 也很简单，使用一个静态字段来存放线程池的引用，返回线程池的代码直接返回这个静态字段即可</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolHelper</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ThreadPoolExecutor</span> threadPoolExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
                <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span>
                <span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setNameFormat</span><span class="token punctuation">(</span><span class="token string">&quot;demo-threadpool-%d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">static</span> <span class="token class-name">ThreadPoolExecutor</span> <span class="token function">getRightThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> threadPoolExecutor<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><h3 id="需要仔细斟酌线程池的混用策略"><a href="#需要仔细斟酌线程池的混用策略" class="header-anchor">#</a> 需要仔细斟酌线程池的混用策略</h3> <p>要根据任务的“轻重缓急”来指定线程池的核心参数，包括线程数、回收策略和任务队列,而不是看见业务中已经有线程池就拿来混用：</p> <ul><li>对于执行比较慢、数量不大的 IO 任务，或许要考虑更多的线程数，而不需要太大的队列。(线程在处理 I/O 的时间段内不会占用 CPU 来处理，这时就可以将 CPU 交出给其它线程使用。所以对于IO任务可以多分配写线程。)</li> <li>而对于吞吐量较大的计算型任务，线程数量不宜过多，可以是 CPU 核数或核数 *2（理由是，线程一定调度到某个 CPU 进行执行，如果任务本身是 CPU 绑定的任务，那么<code>过多的线程</code>只会<code>增加线程切换的开销</code>，<code>并不能提升吞吐量</code>），但可能<code>需要较长的队列来做缓冲</code>。</li></ul> <p>这里，我们模拟一下文件批处理的代码，在程序启动后通过一个线程开启死循环逻辑，不断向线程池提交任务，任务的逻辑是向一个文件中写入大量的数据：</p> <div class="language-java extra-class"><pre class="language-java"><code> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ThreadPoolExecutor</span> threadPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
            <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span>
            <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>HOURS<span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setNameFormat</span><span class="token punctuation">(</span><span class="token string">&quot;batchfileprocess-threadpool-%d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>CallerRunsPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printStats</span><span class="token punctuation">(</span>threadPool<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> payload <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1_000_000</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>__ <span class="token operator">-&gt;</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;demo.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> payload<span class="token punctuation">)</span><span class="token punctuation">,</span> UTF_8<span class="token punctuation">,</span> CREATE<span class="token punctuation">,</span> TRUNCATE_EXISTING<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;batch file processing done&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">2021</span>-12-08 <span class="token number">14</span>:29:34.848  INFO <span class="token number">39440</span> --- <span class="token punctuation">[</span>       Thread-5<span class="token punctuation">]</span> c.z.j.d.c.ThreadPoolMixuseController     <span class="token builtin class-name">:</span> batch <span class="token function">file</span> processing <span class="token keyword">done</span>
<span class="token number">2021</span>-12-08 <span class="token number">14</span>:29:34.848  INFO <span class="token number">39440</span> --- <span class="token punctuation">[</span>ss-threadpool-1<span class="token punctuation">]</span> c.z.j.d.c.ThreadPoolMixuseController     <span class="token builtin class-name">:</span> batch <span class="token function">file</span> processing <span class="token keyword">done</span>
<span class="token number">2021</span>-12-08 <span class="token number">14</span>:29:34.851  INFO <span class="token number">39440</span> --- <span class="token punctuation">[</span>pool-3-thread-1<span class="token punctuation">]</span> c.z.j.d.c.ThreadPoolMixuseController     <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2021</span>-12-08 <span class="token number">14</span>:29:34.851  INFO <span class="token number">39440</span> --- <span class="token punctuation">[</span>pool-3-thread-1<span class="token punctuation">]</span> c.z.j.d.c.ThreadPoolMixuseController     <span class="token builtin class-name">:</span> Pool Size: <span class="token number">2</span>
<span class="token number">2021</span>-12-08 <span class="token number">14</span>:29:34.851  INFO <span class="token number">39440</span> --- <span class="token punctuation">[</span>pool-3-thread-1<span class="token punctuation">]</span> c.z.j.d.c.ThreadPoolMixuseController     <span class="token builtin class-name">:</span> Active Threads: <span class="token number">2</span>
<span class="token number">2021</span>-12-08 <span class="token number">14</span>:29:34.851  INFO <span class="token number">39440</span> --- <span class="token punctuation">[</span>pool-3-thread-1<span class="token punctuation">]</span> c.z.j.d.c.ThreadPoolMixuseController     <span class="token builtin class-name">:</span> Number of Tasks Completed: <span class="token number">2375</span>
<span class="token number">2021</span>-12-08 <span class="token number">14</span>:29:34.851  INFO <span class="token number">39440</span> --- <span class="token punctuation">[</span>pool-3-thread-1<span class="token punctuation">]</span> c.z.j.d.c.ThreadPoolMixuseController     <span class="token builtin class-name">:</span> Number of Tasks <span class="token keyword">in</span> Queue: <span class="token number">99</span>
<span class="token number">2021</span>-12-08 <span class="token number">14</span>:29:34.851  INFO <span class="token number">39440</span> --- <span class="token punctuation">[</span>pool-3-thread-1<span class="token punctuation">]</span> c.z.j.d.c.ThreadPoolMixuseController     <span class="token builtin class-name">:</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2021</span>-12-08 <span class="token number">14</span>:29:34.859  INFO <span class="token number">39440</span> --- <span class="token punctuation">[</span>ss-threadpool-0<span class="token punctuation">]</span> c.z.j.d.c.ThreadPoolMixuseController     <span class="token builtin class-name">:</span> batch <span class="token function">file</span> processing <span class="token keyword">done</span>
<span class="token number">2021</span>-12-08 <span class="token number">14</span>:29:34.859  INFO <span class="token number">39440</span> --- <span class="token punctuation">[</span>       Thread-5<span class="token punctuation">]</span> c.z.j.d.c.ThreadPoolMixuseController     <span class="token builtin class-name">:</span> batch <span class="token function">file</span> processing <span class="token keyword">done</span>
<span class="token number">2021</span>-12-08 <span class="token number">14</span>:29:34.860  INFO <span class="token number">39440</span> --- <span class="token punctuation">[</span>ss-threadpool-1<span class="token punctuation">]</span> c.z.j.d.c.ThreadPoolMixuseController     <span class="token builtin class-name">:</span> batch <span class="token function">file</span> processing <span class="token keyword">done</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>可以看到，线程池的 2 个线程始终处于活跃状态，队列也基本处于打满状态,因为开启了 CallerRunsPolicy 拒绝处理策略，所以当线程满载队列也满的情况下，任务会在提交任务的线程，或者说调用 execute 方法的线程执行，也就是说不能认为提交到线程池的任务就一定是异步处理的。如果使用了 CallerRunsPolicy 策略，那么有可能异步任务变为同步执行。</p></div> <p>业务代码复用这样的线程池来做内存计算，命运一定是悲惨的。我们写一段代码测试下，向线程池提交一个简单的任务，这个任务只是休眠 10 毫秒没有其他逻辑：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ThreadPoolExecutor</span> threadPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
            <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span>
            <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>HOURS<span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setNameFormat</span><span class="token punctuation">(</span><span class="token string">&quot;batchfileprocess-threadpool-%d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>CallerRunsPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">calcTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/03/03/wrong&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> threadPool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token function">calcTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p><code>wrk</code> 工具(http压测工具，目前仅仅支持mac和linux，win可以安装<code>ab</code>进行压测,这里我使用的是windows因此使用<code>ab</code>进行压测)对这个接口进行一个简单的压测，可以看到 TPS(QPS) 为 150.78，性能的确非常差。</p> <p>备注：如果是对一个查询接口（单场景）压测，且这个接口内部不会再去请求其它接口，那么tps=qps，否则，tps≠qps</p> <p><img src="/java-guide/image-20211208152932113.png" alt="image-20211208152932113"></p> <p>其中－n表示请求数，－c表示并发数</p> <ol><li><p>服务器一秒内能接受客户端访问的数量</p></li> <li><p>处理一个请求所需的时间</p></li> <li><p>平均多久处理下一个请求</p></li> <li><p>请求在单位时间内从服务器获取的数据长度</p></li></ol> <p>原因：因为原来执行 IO 任务的线程池使用的是 CallerRunsPolicy 策略，所以直接使用这个线程池进行异步计算的话，当线程池饱和的时候，计算任务会在执行 Web 请求的 Tomcat 线程执行，这时就会进一步影响到其他同步处理的线程，甚至造成整个应用程序崩溃。所以CallerRunsPolicy 策略慎用</p> <p>接下来我们使用默认的拒绝策略，并且提高线程数</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ThreadPoolExecutor</span> asyncCalcThreadPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
  <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span>
  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>HOURS<span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setNameFormat</span><span class="token punctuation">(</span><span class="token string">&quot;asynccalc-threadpool-%d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;right&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> asyncCalcThreadPool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token function">calcTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/java-guide/image-20211208153544125.png" alt="image-20211208153544125"></p> <p>盲目复用线程池混用线程的问题在于，别人定义的线程池属性<code>不一定适合你的任务</code>，而且混用会相互干扰.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/vuejs/vuepress/edit/master/packages/docs/docs/java-guide/线程池：业务代码最常用也最容易犯错的组件.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/2/18 上午10:52:39</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/java-guide/代码加锁：不要让“锁”事成为烦心事.html" class="prev">
        代码加锁：不要让“锁”事成为烦心事
      </a></span> <span class="next"><a href="/java-guide/连接池：别让连接池帮了倒忙.html">
        连接池：别让连接池帮了倒忙
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----><!----><!----></div></div>
    <script src="/assets/js/app.75796fb8.js" defer></script><script src="/assets/js/5.4faacd21.js" defer></script><script src="/assets/js/70.8c66f40e.js" defer></script><script src="/assets/js/9.fd263465.js" defer></script>
  </body>
</html>
